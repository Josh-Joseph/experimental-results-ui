<head>
    <link rel="stylesheet" href="style.css" media="screen">
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/dojo/1.9.0/dijit/themes/claro/claro.css" media="screen">
    <script src="../dojo/dojo.js"
        data-dojo-config="async:1">
    </script>
    <script>
    require(["dijit/registry", 
             "dijit/layout/BorderContainer",
             "dijit/layout/TabContainer", 
             "dijit/layout/ContentPane", 
             "dojo/io-query",
             "dojo/domReady!"],
        function(registry, BorderContainer, TabContainer, ContentPane, ioQuery){

    // create the main bordercontainer layout panel
    // attached to the appLayout DIV
    var appLayout = new BorderContainer({
      design : "headline"
    }, "appLayout" );
    
    
    // create the tab container
    var contentTabs = new TabContainer({
      region: "center",
      id: "contentTabs",
      tabPosition: "bottom",
      "class": "centerPanel"
    });
    
    // add the tab container to the appLayout
    appLayout.addChild( contentTabs );
    
    // add the header top and edge panels
    appLayout.addChild( 
      new ContentPane({
        region: "top",
        "class": "edgePanel",
        content: "Header Content (top)"
    }));
    
    appLayout.addChild(
      new ContentPane({
        region: "left",
        id: "leftCol",
        "class": "edgePanel",
        splitter: true,
        content: "Sidebar content (left)"
    }));

    // add initial tab
    var query_string = ""
    if( window.location.href.indexOf("?") >= 0 ) {
      query_string = window.location.href.substr( window.location.href.indexOf("?") + 1 );
    }
    contentTabs.addChild(
      new ContentPane({
        content: "href = " + window.location.href + "<br><br>Query JSON:" + dojo.toJson(ioQuery.queryToObject(query_string)),
        title: "Arguments"
    }));

    // start up anbd do layout
    appLayout.startup();

        });
    </script>
</head>
<body class="claro">
    <div id="appLayout" class="demoLayout"></div>
    
    <script>
      require(["dijit/registry", 
               "dijit/layout/BorderContainer",
               "dijit/layout/TabContainer", 
               "dijit/layout/ContentPane", 
               "dojo/io-query",
               "dojo/store/Observable",
               "dojo/store/CouchdbStore",
               "dojo/domReady!"],
      function(registry, BorderContainer, TabContainer, 
               ContentPane, ioQuery, Observable, CouchdbStore ){

      // grab all known clsuters into a store
      
      // create a dataztore from the clusters couchdb database
      var store = new Observable( new CouchdbStore({
        target: "http://localhost:5984/clusters/_design/ui/_view/all"
      }));

      // create a datastore for hte jobs database view by clsuter id
      var jobs_store_by_cluster = new Observable( new CouchdbStore({
        target: "http://localhost:5984/jobs/_design/ui/_view/by_cluster_id"
      }));

      // get the tab container
      var tabContainer = registry.byId("contentTabs");

      // for every known clsuter, create a new tab
      store.query({ startKey: {} }).forEach(function(row){
        
      
        // now, ask for the jobs for this cluster and list them out
        var c = dojo.toJson( row ) + "<br><br>"
	var contentPane = new ContentPane({
          title: "cluster: " + row.value.cluster.hostname,
          content: c
        });

	jobs_store_by_cluster.query( { key: dojo.toJson(row.value.cluster.cluster_id) } ).forEach(function( job_row ) {
	  console.log( "Got job: " + dojo.toJson( job_row ) );

          c += "<li><h3>" + job_row.value.job.status + "</h3>";
	  c += "<h4>" + job_row.value.job.script + "</h4>";
	  c += "\n";
	  contentPane.set( 'content', c );
	});
	
      
        // add the content pane
        tabContainer.addChild( contentPane );
      });
      
      });
    </script>
</body>
